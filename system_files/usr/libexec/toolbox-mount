#!/bin/bash

LOG_FILE="/tmp/toolbox-debug.log"
echo "$(date): Starting toolbox-mount" >> "$LOG_FILE"

# If run as `toolbox-mount --replace`, pass that flag to `distrobox assemble`
REPLACE=""
if [ "$1" = "--replace" ]; then
  REPLACE="--replace"
fi

TOOLBOX_NAME="toolbox"
CONFIG_FILE="$HOME/.config/dune-os/toolbox.ini"

if [ -f "$CONFIG_FILE" ]; then
  echo "$(date): User config found at $CONFIG_FILE" >> "$LOG_FILE"
  # Set TOOLBOX_NAME to first [<name>] in toolbox.ini
  TOOLBOX_NAME=$(
    /usr/bin/grep '^\[' "$CONFIG_FILE" |
      /usr/bin/head -1 |
      /usr/bin/sed 's/\[\s*\(.*\)\s*\]/\1/'
  )
  echo "$(date): Parsed TOOLBOX_NAME='$TOOLBOX_NAME'" >> "$LOG_FILE"

  # Ensure entry=true
  TEMP_CONFIG=$(mktemp)
  /usr/bin/cp "$CONFIG_FILE" "$TEMP_CONFIG"

  if ! /usr/bin/grep -q '^entry=true' "$TEMP_CONFIG"; then
    /usr/bin/sed -i '/^entry=/d' "$TEMP_CONFIG"
    /usr/bin/sed -i "/^\[$TOOLBOX_NAME\]/a entry=true" "$TEMP_CONFIG"
  fi

  echo "$(date): Running distrobox assemble create -v $REPLACE --file $TEMP_CONFIG" >> "$LOG_FILE"
  /usr/bin/distrobox assemble create -v $REPLACE --file "$TEMP_CONFIG"
  ASSEMBLE_EXIT=$?
  echo "$(date): distrobox assemble exited with $ASSEMBLE_EXIT" >> "$LOG_FILE"
  if [ $ASSEMBLE_EXIT -ne 0 ]; then
    echo "$(date): Failed to assemble toolbox from user config" >> "$LOG_FILE"
    /usr/bin/rm -rf "$TEMP_CONFIG"
    exit 1
  fi
  /usr/bin/rm -rf "$TEMP_CONFIG"

elif [ -f /usr/share/dune-os/toolbox.ini ]; then
  echo "$(date): Using default config at /usr/share/dune-os/toolbox.ini" >> "$LOG_FILE"
  /usr/bin/distrobox assemble create -v $REPLACE --file /usr/share/dune-os/toolbox.ini
  ASSEMBLE_EXIT=$?
  echo "$(date): distrobox assemble exited with $ASSEMBLE_EXIT" >> "$LOG_FILE"
  if [ $ASSEMBLE_EXIT -ne 0 ]; then
    echo "$(date): Failed to assemble toolbox from default config" >> "$LOG_FILE"
    exit 1
  fi

else
  echo "$(date): Can't find toolbox.ini configuration file..." >> "$LOG_FILE"
  echo "Can't find toolbox.ini configuration file..."
  exit 1
fi
