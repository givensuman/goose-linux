#!/bin/bash

LOG_FILE="/tmp/toolbox-debug.log"
echo "$(date): Starting toolbox-launch" >>"$LOG_FILE"

if ! systemctl --user is-enabled toolbox.service >/dev/null 2>&1; then
  echo "$(date): Toolbox service not enabled, launching system shell" >>"$LOG_FILE"
  exec /usr/bin/ghostty --gtk-single-instance=true
fi

TOOLBOX_NAME="toolbox"
CONFIG_FILE="${HOME}/.config/dune-os/toolbox.ini"

if [ -f "$CONFIG_FILE" ]; then
  echo "$(date): User config found at $CONFIG_FILE" >>"$LOG_FILE"
  # Set TOOLBOX_NAME to first [<name>] in toolbox.ini
  TOOLBOX_NAME=$(
    /usr/bin/grep '^\[' "$CONFIG_FILE" |
      /usr/bin/head -1 |
      /usr/bin/sed 's/\[\s*\(.*\)\s*\]/\1/'
  )
  echo "$(date): Parsed TOOLBOX_NAME='$TOOLBOX_NAME'" >>"$LOG_FILE"
else
  echo "$(date): No user config, using default TOOLBOX_NAME='$TOOLBOX_NAME'" >>"$LOG_FILE"
fi

# Create toolbox if removed
if ! /usr/bin/distrobox list --no-color | /usr/bin/grep -q "$TOOLBOX_NAME"; then
  echo "$(date): Toolbox '$TOOLBOX_NAME' not found, running toolbox-mount" >>"$LOG_FILE"
  /usr/libexec/toolbox-mount
  MOUNT_EXIT=$?
  echo "$(date): toolbox-mount exited with $MOUNT_EXIT" >>"$LOG_FILE"
  if [ $MOUNT_EXIT -ne 0 ]; then
    notify-send "Failed to create toolbox container"
  fi
else
  echo "$(date): Toolbox '$TOOLBOX_NAME' already exists" >>"$LOG_FILE"
fi

echo "[DEBUG] TOOLBOX_NAME=$TOOLBOX_NAME"
echo "[DEBUG] CONFIG_FILE=$([[ -f $CONFIG_FILE ]] && echo "found" || echo "not found")"

# Launch toolbox inside of Ghostty
echo "$(date): Launching ghostty with distrobox enter '$TOOLBOX_NAME'" >>"$LOG_FILE"
if [ $MOUNT_EXIT -ne 0 ]; then
  notify-send "Failed to create Toolbox container"
  /usr/bin/ghostty --gtk-single-instance=true
else
  /usr/bin/ghostty --gtk-single-instance=true -e distrobox enter "$TOOLBOX_NAME"
fi
GHOSTTY_EXIT=$?
echo "$(date): ghostty exited with $GHOSTTY_EXIT" >>"$LOG_FILE"

# Ruh-roh
[ $GHOSTTY_EXIT -eq 0 ] || notify-send "Failed to launch Ghostty with toolbox"
