#!/bin/bash

# Function to get value from config
get_value() {
  local file=$1
  local key=$2
  grep "^$key =" "$file" | sed 's/.*= //' | tr -d '"'
}

# Determine the default container name from config
container_name=""
config_files=("/etc/containers/toolbox.conf" "$HOME/.config/containers/toolbox.conf")
for config in "${config_files[@]}"; do
  if [ -f "$config" ]; then
    distro=$(get_value "$config" "distro")
    release=$(get_value "$config" "release")
    image=$(get_value "$config" "image")
    if [ -n "$image" ]; then
      # Extract container name from image, e.g., registry.fedoraproject.org/fedora-toolbox:36 -> fedora-toolbox-36
      container_name=$(echo "$image" | sed 's|.*/||' | sed 's|:|-|')
    elif [ -n "$distro" ] && [ -n "$release" ]; then
      container_name="${distro}-toolbox-${release}"
    elif [ -n "$distro" ]; then
      container_name="${distro}-toolbox"
    fi
  fi
done

# Fallback to default if no config
if [ -z "$container_name" ]; then
  release=$(rpm -E %fedora 2>/dev/null || echo "39")
  container_name="fedora-toolbox-${release}"
fi

# Check if the default toolbox container exists
if [ podman ps -a --filter label=com.github.containers.toolbox=true --format "{{.Names}}" | grep -q "^$container_name$" ]; then
  # Notify user about the delay
  notify-send "Creating toolbox container..." "This may take a moment."
  # Create the default toolbox
  toolbox create -y
fi

# Enter the toolbox
toolbox enter
